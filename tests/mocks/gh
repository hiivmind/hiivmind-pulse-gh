#!/usr/bin/env bash
# Enhanced Mock gh CLI
# Registry-based request routing and response management

set -euo pipefail

# =============================================================================
# INITIALIZATION
# =============================================================================

MOCK_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Source the registry system
source "${MOCK_DIR}/registry.bash"

# Initialize if not already done
if [[ ! -f "${MOCK_REGISTRY_FILE:-}" ]]; then
    init_mock_registry "${MOCK_CONFIG_DIR:-/tmp/mock_gh_$$}"
fi

# =============================================================================
# COMMAND ROUTING
# =============================================================================

# Main command router
route_command() {
    local command="${1:-}"
    shift || true

    case "$command" in
        api)
            handle_api_command "$@"
            ;;
        secret)
            handle_secret_command "$@"
            ;;
        variable)
            handle_variable_command "$@"
            ;;
        project)
            handle_project_command "$@"
            ;;
        auth)
            handle_auth_command "$@"
            ;;
        issue)
            handle_issue_command "$@"
            ;;
        pr)
            handle_pr_command "$@"
            ;;
        release)
            handle_release_command "$@"
            ;;
        repo)
            handle_repo_command "$@"
            ;;
        *)
            echo "gh: unknown command: $command" >&2
            exit 1
            ;;
    esac
}

# =============================================================================
# API COMMAND HANDLING
# =============================================================================

handle_api_command() {
    local subcommand="${1:-}"
    shift || true

    case "$subcommand" in
        graphql)
            handle_graphql_api "$@"
            ;;
        *)
            # REST API call
            handle_rest_api "$subcommand" "$@"
            ;;
    esac
}

handle_graphql_api() {
    local query=""

    # Parse arguments to extract query
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -f|--field)
                if [[ "$2" == "query="* ]]; then
                    query="${2#query=}"
                fi
                shift 2
                ;;
            *)
                shift
                ;;
        esac
    done

    # Handle the GraphQL request
    if [[ -n "$query" ]]; then
        handle_graphql_request "$query"
    else
        echo '{"errors":[{"message":"No query provided"}]}'
        exit 1
    fi
}

handle_rest_api() {
    local endpoint="$1"
    shift || true

    local method="GET"

    # Parse arguments for method
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -X|--method)
                method="$2"
                shift 2
                ;;
            *)
                shift
                ;;
        esac
    done

    # Handle the REST request
    handle_rest_request "$method" "$endpoint"
}

# =============================================================================
# CLI COMMAND HANDLING
# =============================================================================

handle_secret_command() {
    local subcommand="${1:-list}"
    shift || true

    case "$subcommand" in
        list)
            handle_cli_command "secret" "list" "$@"
            ;;
        set)
            echo "Secret set (mock)" >&2
            ;;
        delete)
            echo "Secret deleted (mock)" >&2
            ;;
        *)
            handle_cli_command "secret" "$subcommand" "$@"
            ;;
    esac
}

handle_variable_command() {
    local subcommand="${1:-list}"
    shift || true

    case "$subcommand" in
        list)
            handle_cli_command "variable" "list" "$@"
            ;;
        set)
            echo "Variable set (mock)" >&2
            ;;
        delete)
            echo "Variable deleted (mock)" >&2
            ;;
        *)
            handle_cli_command "variable" "$subcommand" "$@"
            ;;
    esac
}

handle_project_command() {
    local subcommand="${1:-list}"
    shift || true

    case "$subcommand" in
        list)
            handle_cli_command "project" "list" "$@"
            ;;
        view)
            handle_cli_command "project" "view" "$@"
            ;;
        item-add|item-list|item-delete)
            handle_cli_command "project" "$subcommand" "$@"
            ;;
        *)
            handle_cli_command "project" "$subcommand" "$@"
            ;;
    esac
}

handle_auth_command() {
    local subcommand="${1:-status}"

    case "$subcommand" in
        status)
            echo "Logged in to github.com as test-user (mock)"
            ;;
        token)
            echo "ghp_mock_token_12345"
            ;;
        *)
            echo "Mock auth command: $subcommand"
            ;;
    esac
}

handle_issue_command() {
    local subcommand="${1:-list}"
    shift || true

    handle_cli_command "issue" "$subcommand" "$@"
}

handle_pr_command() {
    local subcommand="${1:-list}"
    shift || true

    handle_cli_command "pr" "$subcommand" "$@"
}

handle_release_command() {
    local subcommand="${1:-list}"
    shift || true

    handle_cli_command "release" "$subcommand" "$@"
}

handle_repo_command() {
    local subcommand="${1:-view}"
    shift || true

    handle_cli_command "repo" "$subcommand" "$@"
}

# =============================================================================
# MAIN
# =============================================================================

# Route the command
route_command "$@"
