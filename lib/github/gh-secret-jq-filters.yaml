# GitHub Secrets jq Filters
# Transformation and formatting filters for secrets

# =============================================================================
# FORMAT FILTERS
# =============================================================================

filters:
  # Format secrets as tabular list
  format_secrets_list:
    description: Format secrets array as table
    filter: |
      ["NAME", "UPDATED", "VISIBILITY", "REPOS"] as $headers |
      [$headers],
      (.[] | [
        .name,
        .updatedAt,
        (.visibility // "-"),
        (.numSelectedRepos // "-")
      ]) |
      @tsv

  # Format single secret with details
  format_secret_detail:
    description: Format single secret with all metadata
    filter: |
      "Secret Name: \(.name)",
      "Created: \(.created_at // "N/A")",
      "Updated: \(.updated_at // .updatedAt)",
      "Visibility: \(.visibility // "N/A")",
      "Selected Repos: \(.num_selected_repos // .numSelectedRepos // "N/A")",
      "Selected Repos URL: \(.selected_repositories_url // .selectedReposURL // "N/A")"

  # Format public key
  format_public_key:
    description: Format public key with key_id
    filter: |
      "Key ID: \(.key_id)",
      "Public Key: \(.key)"

  # Format repository access list
  format_secret_repos:
    description: Format list of repositories with access
    filter: |
      ["REPO_ID", "NAME", "FULL_NAME"] as $headers |
      [$headers],
      (.[] | [.id, .name, .full_name]) |
      @tsv

# =============================================================================
# EXTRACT FILTERS
# =============================================================================

  # Extract secret names
  extract_secret_names:
    description: Extract array of secret names
    filter: |
      map(.name)

  # Extract selected repository IDs
  extract_selected_repo_ids:
    description: Extract repository IDs from org secret repo list
    filter: |
      map(.id)

  # Extract secrets with visibility
  extract_by_visibility:
    description: Extract secrets grouped by visibility
    filter: |
      group_by(.visibility) |
      map({visibility: .[0].visibility, secrets: map(.name)})

# =============================================================================
# FILTER OPERATIONS
# =============================================================================

  # Filter by visibility
  filter_by_visibility:
    description: Filter org secrets by visibility (requires --arg visibility VALUE)
    filter: |
      map(select(.visibility == $visibility))

  # Filter by name pattern
  filter_by_name:
    description: Filter secrets by name pattern (requires --arg pattern VALUE)
    filter: |
      map(select(.name | test($pattern)))

  # Filter secrets updated after date
  filter_updated_after:
    description: Filter secrets updated after date (requires --arg date ISO8601)
    filter: |
      map(select(.updatedAt > $date or .updated_at > $date))

  # Filter secrets with selected repos
  filter_with_selected_repos:
    description: Keep only secrets with selected repository access
    filter: |
      map(select(.visibility == "selected"))

# =============================================================================
# SUMMARY FILTERS
# =============================================================================

  # Count secrets by visibility
  count_by_visibility:
    description: Count organization secrets grouped by visibility
    filter: |
      group_by(.visibility) |
      map({visibility: .[0].visibility, count: length})

  # Secret summary
  secret_summary:
    description: Summarize secrets (total count, visibility breakdown)
    filter: |
      {
        total: length,
        by_visibility: (
          group_by(.visibility) |
          map({visibility: .[0].visibility, count: length})
        ),
        recent_updates: (
          sort_by(.updatedAt // .updated_at) |
          reverse |
          .[0:5] |
          map({name: .name, updated: (.updatedAt // .updated_at)})
        )
      }

# =============================================================================
# TRANSFORMATION FILTERS
# =============================================================================

  # Normalize gh CLI format to REST format
  normalize_secret_from_cli:
    description: Normalize gh CLI secret format to REST API format
    filter: |
      {
        name: .name,
        updated_at: .updatedAt,
        visibility: .visibility,
        selected_repositories_url: .selectedReposURL,
        num_selected_repos: .numSelectedRepos
      }

  # Add metadata for tracking
  add_scope_metadata:
    description: Add scope field to secret objects (requires --arg scope VALUE)
    filter: |
      map(. + {scope: $scope})
