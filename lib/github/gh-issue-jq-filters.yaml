# GitHub Issue Domain - jq Filter Templates
# Part of hiivmind-pulse-gh domain segmentation architecture
#
# Usage:
#   fetch_issue "owner" "repo" 123 | jq -f <(yq '.format_filters.format_issue.filter' gh-issue-jq-filters.yaml)

#==============================================================================
# FORMAT FILTERS (GraphQL)
#==============================================================================
# Transform GraphQL responses into clean, display-ready JSON

format_filters:
  format_issue:
    description: "Format single issue from GraphQL response"
    input: "GraphQL response from queries.issue_by_number"
    filter: |
      .data.repository.issue | {
        id: .id,
        number: .number,
        title: .title,
        body: (.body // ""),
        state: .state,
        stateReason: (.stateReason // null),
        url: .url,
        author: .author.login,
        assignees: [.assignees.nodes[].login],
        labels: [.labels.nodes[] | {name: .name, color: .color}],
        milestone: (if .milestone then {number: .milestone.number, title: .milestone.title} else null end),
        commentCount: .comments.totalCount,
        reactionCount: .reactions.totalCount,
        createdAt: .createdAt,
        updatedAt: .updatedAt,
        closedAt: (.closedAt // null)
      }

  format_issues_list:
    description: "Format issue list from GraphQL response"
    input: "GraphQL response from queries.repository_issues or discover_repo_issues"
    filter: |
      {
        totalCount: .data.repository.issues.totalCount,
        issues: [
          .data.repository.issues.nodes[] | {
            id: .id,
            number: .number,
            title: .title,
            state: .state,
            url: .url,
            author: .author.login,
            assignees: [.assignees.nodes[].login],
            labels: [.labels.nodes[].name],
            milestone: (.milestone.title // null),
            createdAt: .createdAt,
            updatedAt: .updatedAt
          }
        ]
      }

  format_issue_with_comments:
    description: "Format issue with its comments"
    input: "GraphQL response from queries.issue_with_comments"
    filter: |
      .data.repository.issue | {
        id: .id,
        number: .number,
        title: .title,
        body: (.body // ""),
        state: .state,
        url: .url,
        author: .author.login,
        comments: {
          totalCount: .comments.totalCount,
          items: [.comments.nodes[] | {
            id: .id,
            author: .author.login,
            body: .body,
            createdAt: .createdAt,
            updatedAt: .updatedAt
          }]
        }
      }

  format_issues_summary:
    description: "Format issues as compact summary"
    input: "GraphQL response from queries.repository_issues"
    filter: |
      [.data.repository.issues.nodes[] | {
        number: .number,
        title: .title,
        state: .state,
        labels: [.labels.nodes[].name]
      }]

#==============================================================================
# FORMAT FILTERS (REST)
#==============================================================================
# Transform REST API responses

rest_format_filters:
  format_issues_rest:
    description: "Format issue list from REST API response"
    input: "JSON array from REST API /repos/:owner/:repo/issues"
    filter: |
      [.[] | select(.pull_request == null) | {
        number: .number,
        title: .title,
        state: .state,
        url: .html_url,
        author: .user.login,
        assignees: [.assignees[].login],
        labels: [.labels[].name],
        milestone: (.milestone.title // null),
        createdAt: .created_at,
        updatedAt: .updated_at,
        closedAt: (.closed_at // null)
      }]

  format_issue_rest:
    description: "Format single issue from REST API response"
    input: "JSON object from REST API /repos/:owner/:repo/issues/:number"
    filter: |
      {
        number: .number,
        title: .title,
        body: (.body // ""),
        state: .state,
        url: .html_url,
        author: .user.login,
        assignees: [.assignees[].login],
        labels: [.labels[].name],
        milestone: (if .milestone then {number: .milestone.number, title: .milestone.title} else null end),
        commentCount: .comments,
        createdAt: .created_at,
        updatedAt: .updated_at,
        closedAt: (.closed_at // null)
      }

#==============================================================================
# EXTRACT FILTERS
#==============================================================================
# Pull out specific fields from responses

extract_filters:
  extract_issue_id:
    description: "Extract issue node ID from GraphQL response"
    input: "GraphQL response from queries.issue_by_number"
    filter: |
      .data.repository.issue.id

  extract_issue_numbers:
    description: "Extract issue numbers as array"
    input: "GraphQL response from queries.repository_issues"
    filter: |
      [.data.repository.issues.nodes[].number]

  extract_issue_ids:
    description: "Extract issue node IDs as array"
    input: "GraphQL response from queries.repository_issues"
    filter: |
      [.data.repository.issues.nodes[].id]

  extract_issue_titles:
    description: "Extract issue titles as array"
    input: "GraphQL response from queries.repository_issues"
    filter: |
      [.data.repository.issues.nodes[].title]

  extract_open_issues:
    description: "Extract only open issues"
    input: "GraphQL response from queries.repository_issues"
    filter: |
      [.data.repository.issues.nodes[] | select(.state == "OPEN")]

  extract_closed_issues:
    description: "Extract only closed issues"
    input: "GraphQL response from queries.repository_issues"
    filter: |
      [.data.repository.issues.nodes[] | select(.state == "CLOSED")]

  extract_issues_by_label:
    description: "Extract issues with a specific label"
    input: "GraphQL response from queries.repository_issues"
    args:
      - name: label
        description: "Label name to filter by"
    filter: |
      [.data.repository.issues.nodes[] | select(.labels.nodes | any(.name == $label))]

  extract_issues_by_assignee:
    description: "Extract issues assigned to a specific user"
    input: "GraphQL response from queries.repository_issues"
    args:
      - name: assignee
        description: "Assignee login to filter by"
    filter: |
      [.data.repository.issues.nodes[] | select(.assignees.nodes | any(.login == $assignee))]

  extract_issues_by_milestone:
    description: "Extract issues in a specific milestone"
    input: "GraphQL response from queries.repository_issues"
    args:
      - name: milestone
        description: "Milestone title to filter by"
    filter: |
      [.data.repository.issues.nodes[] | select(.milestone != null and .milestone.title == $milestone)]

#==============================================================================
# COMPACT/SHELL-SAFE VERSIONS
#==============================================================================
# Single-line versions for shell safety

compact:
  format_issue: '.data.repository.issue | {number: .number, title: .title, state: .state, author: .author.login, labels: [.labels.nodes[].name]}'

  format_issues_list: '{totalCount: .data.repository.issues.totalCount, issues: [.data.repository.issues.nodes[] | {number: .number, title: .title, state: .state}]}'

  extract_issue_numbers: '[.data.repository.issues.nodes[].number]'

  format_issues_rest: '[.[] | select(.pull_request == null) | {number: .number, title: .title, state: .state, labels: [.labels[].name]}]'

#==============================================================================
# USAGE EXAMPLES
#==============================================================================

examples:
  format_issue:
    description: "Format a single issue"
    command: |
      fetch_issue "owner" "repo" 123 | jq -f <(yq '.format_filters.format_issue.filter' gh-issue-jq-filters.yaml)

  filter_by_label:
    description: "Get issues with a specific label"
    command: |
      discover_repo_issues "owner" "repo" | jq --arg label "bug" -f <(yq '.extract_filters.extract_issues_by_label.filter' gh-issue-jq-filters.yaml)

  format_rest:
    description: "Format REST API issue list"
    command: |
      list_issues_rest "owner" "repo" | jq -f <(yq '.rest_format_filters.format_issues_rest.filter' gh-issue-jq-filters.yaml)

#==============================================================================
# NOTES
#==============================================================================

notes:
  rest_excludes_prs: |
    REST API /repos/:owner/:repo/issues returns both issues AND pull requests.
    The format_issues_rest filter excludes PRs by checking for absence of .pull_request field.

  graphql_vs_rest: |
    GraphQL responses use camelCase (createdAt, stateReason)
    REST responses use snake_case (created_at, state_reason)
    The format filters normalize these differences.

  label_colors: |
    Label colors are 6-character hex codes without the leading #.
    Example: "d73a4a" for the default "bug" label red.
